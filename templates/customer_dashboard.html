{% extends 'base_dashboard.html' %}
{% block content %}
<main class="dashboard">
    <nav class="nav nav-tabs nav-pills flex-column text-center p-4">
        <h4 class="h2 py-3 py-xl-5">Dashboard</h4>

        <button class="fs-5 pr-2 nav-link active" data-bs-toggle="tab" href="#featured" data-bs-target="#featured" type="button" role="tab">
            <span class="material-icons align-middle">menu_book</span>
            Menu
        </button>
        <button style="white-space: nowrap;" class="fs-5 pr-2 nav-link" data-bs-toggle="tab" href="#order_status"
            data-bs-target="#order_status" type="button" role="tab">
            <span class="material-icons align-middle">schedule</span>
            My Orders
        </button>

    </nav>


    <div class="flex-grow-1 tab-content p-md-5 bg-light">
        <section class="tab-pane active in" role="tabpanel" id="featured">
            <!-- <div class="row"> -->
            <!-- <img src="{{ url_for('static', filename='images/menu.jpg') }}" alt="" class="d-none d-xl-block col-xl-4"> -->

            <div class="p-5">
                <h2>Menu</h2>
                <p>
                    Lorem, ipsum dolor sit amet consectetur adipisicing elit. Voluptate fugit expedita minima,
                    aperiam error ut.
                </p>
                {% set v = {'s': False, 'm': False, 'd': False, 'b': False, 'f': False} %}
                {% for item in menu %}
                {% if not v.s and item.type == 's' %}
                <div class="card border-primary">
                    <div class="card-header text-primary h4 p-3">Starters</div>
                    <div class="card-body">
                        <div class="card-deck">
                            {% if v.update({'s': True, 'm': False, 'd': False, 'b': False, 'f': False}) %} {% endif %}
                            {% endif %}

                            {% if not v.m and item.type == 'm' %}
                        </div>
                    </div>
                </div>
                <br>
                <div class="card border-primary">
                    <div class="card-header text-primary h4 p-3">Main Course</div>
                    <div class="card-body">
                        <div class="card-deck">
                            {% if v.update({'s': True, 'm': True, 'd': False, 'b': False, 'f': False}) %} {% endif %}
                            {% endif %}

                            {% if not v.d and item.type == 'd' %}
                        </div>
                    </div>
                </div>
                <br>
                <div class="card border-primary">
                    <div class="card-header text-primary h4 p-3">Dessert</div>
                    <div class="card-body">
                        <div class="card-deck">
                            {% if v.update({'s': True, 'm': True, 'd': True, 'b': False, 'f': False}) %} {% endif %}
                            {% endif %}

                            {% if not v.b and item.type == 'b' %}
                        </div>
                    </div>
                </div>
                <br>
                <div class="card border-primary">
                    <div class="card-header text-primary h4 p-3">Beverages</div>
                    <div class="card-body">
                        <div class="card-deck">
                            {% if v.update({'s': True, 'm': True, 'd': True, 'b': True, 'f': False}) %} {% endif %}
                            {% endif %}
                            <div class="card border-dark">
                                <img src="{{ url_for('static', filename='images/'+ item.name +'.jpg') }}"
                                    class="card-img-top" alt="...">
                                <div class="card-body d-flex flex-column">
                                    <h3 class="card-title d-inline-flex justify-content-between w-100">
                                        <span>{{ item.name }}</span>
                                        <span>AED {{ '%.2f' % item.price }}</span>
                                    </h3>
                                    <p class="card-text">{{ item.desc }}</p>
                                    <div class="btn-group w-100 mt-auto" role="group">
                                        <a onclick="dec('{{ item.type }}{{ item.id }}');" type="button"
                                            class="btn btn-danger text-light" type="button"><span
                                                class="material-icons">remove</span></a>
                                        <a class="btn p-0 fs-3" id="{{ item.type }}{{ item.id }}">0</a>
                                        <div class="btn-group flex-grow-1" type="button">
                                            <a class="btn btn-primary text-light flex-grow-1" type="button"
                                            onclick="inc('{{ item.type }}{{ item.id }}');"><span
                                                class="material-icons">add</span></a>
                                            <button type="button" class="btn btn-primary text-light dropdown-toggle dropdown-toggle-split" id="dropdownMenuReference" data-bs-toggle="dropdown" aria-expanded="false" data-bs-reference="parent">
                                                <span class="visually-hidden">Toggle Dropdown</span>
                                            </button>
                                            <div class="dropdown-menu p-3 form-floating" aria-labelledby="dropdownMenuExtraInfo">
                                                <textarea class="form-control" placeholder="Add Additional Details Here" id="{{ item.type }}{{ item.id }}_add_info"></textarea>
                                                <label for="{{ item.type }}{{ item.id }}_add_info">Add Additional Details</label>
                                              </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% if item == menu[-1] %}
                            {% if v.update({'s': True, 'm': True, 'd': True, 'b': True, 'f': True}) %} {% endif %}
                            {% endif %}
                            {% if v.s and v.m and v.d and v.b and v.f %}
                        </div>
                    </div>
                </div>
                <br>
                {% endif %}
                {% endfor %}
                <div class="text-center">
                    <a class="btn btn-primary text-light w-50" onclick="placeOrder();">Place Order</a>
                </div>
            </div>
            <!-- </div> -->

        </section>
        <section class="tab-pane in" role="tabpanel" id="order_status">
            <h3>Orders</h3>
            <div class="card card-deck py-4 px-3">

                {% for order in my_orders.values() %}

                <div class="card bg-{{'light' if order.delivered == 0 else 'primary'}} text-{{'primary' if order.delivered == 0 else 'light'}} p-3">
                    <strong class="card-title">Order {{order.ordNum}}<br>Placed: {{order.date.strftime('%H:%M:%S')}}</strong>
                    <ul class="card-body">

                        {% for item in order.items %}
                            <li>{{item.name}}<br>x{{item.qty}}<br>{{item.addinfo if item.addinfo else ''}}</li>
                        {% endfor %}

                    </ul>
                    <strong class="card-footer">{{'In the kitchen' if order.prepared == 0 else 'On its way to you' if order.delivered == 0 else 'Served'}}</strong>
                </div>
                
                {% endfor %}
                
            </div>
    </div>

</main>

<script>


    var intervalId = setInterval(function() {
        $('#order_status').load(document.URL +  ' #order_status')
    }, 2000);

    function inc(id) {
        document.getElementById(id).innerHTML = parseInt(document.getElementById(id).innerHTML) + 1;
    }

    function dec(id) {
        var qty = parseInt(document.getElementById(id).innerHTML);
        document.getElementById(id).innerHTML = (qty == 0) ? 0 : qty - 1;
    }

    function placeOrder() {
        var xhr = new XMLHttpRequest();
        var data = {};
        var i = 0;
        while (true) {
            var ele = document.getElementById("m" + i);
            if (ele) {
                data["m" + i] = {"qty": ele.innerHTML, "addinfo": document.getElementById("m" + i + "_add_info").value};
                ele.innerHTML = 0;
                document.getElementById("m" + i + "_add_info").value = "";
            }
            else {
                ele = document.getElementById("s" + i);
                if (ele) {
                    data["s" + i] = {"qty": ele.innerHTML, "addinfo": document.getElementById("s" + i + "_add_info").value};
                    ele.innerHTML = 0;
                    document.getElementById("s" + i + "_add_info").value = "";
                }
                else {
                    ele = document.getElementById("b" + i);
                    if (ele) {
                        data["b" + i] = {"qty": ele.innerHTML, "addinfo": document.getElementById("b" + i + "_add_info").value};
                        ele.innerHTML = 0;
                        document.getElementById("b" + i + "_add_info").value = "";
                    }
                    else {
                        ele = document.getElementById("d" + i);
                        if (ele) {
                            data["d" + i] = {"qty": ele.innerHTML, "addinfo": document.getElementById("d" + i + "_add_info").value};
                            ele.innerHTML = 0;
                            document.getElementById("d" + i + "_add_info").value = "";
                        }
                        else {
                            break;
                        }
                    }
                }
            }
            i = i + 1;
        }

        // console.log(JSON.stringify(data));

        xhr.open("POST", "/place", true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(data));
        if (xhr.readyState == XMLHttpRequest.DONE) {
            console.log(xhr.responseText);
        }
        // console.log(xhr.responseText);

        setTimeout(function() {
            $('#order_status').load(document.URL +  ' #order_status');
        }, 500);

        $('.nav-tabs button[href="#order_status"]').tab('show'); // auto tab switch to order status
        // alert('done');
    }
</script>
{% endblock content %}